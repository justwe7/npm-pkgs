var b=Object.defineProperty;var v=(n,e,i)=>e in n?b(n,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):n[e]=i;var u=(n,e,i)=>(v(n,typeof e!="symbol"?e+"":e,i),i);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const t of r)if(t.type==="childList")for(const o of t.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&a(o)}).observe(document,{childList:!0,subtree:!0});function i(r){const t={};return r.integrity&&(t.integrity=r.integrity),r.referrerpolicy&&(t.referrerPolicy=r.referrerpolicy),r.crossorigin==="use-credentials"?t.credentials="include":r.crossorigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function a(r){if(r.ep)return;r.ep=!0;const t=i(r);fetch(r.href,t)}})();function y(n,e,i){return new Promise(a=>{const r=new FileReader;r.onload=function(){if(e)typeof e=="boolean"?p(n).then(t=>{a({file:x(t,n.name||w(n)),base64:t})}):p(n,e.compressQuality,e.maxWidth,e.rotate,e.exifruri).then(t=>{a({file:x(t,n.name||w(n)),base64:t})});else if(i){const t=this.result;L(t).then(o=>{const g={base64:o,file:x(o,"cover.jpeg")};a({file:n,base64:t,cover:g})})}else a({file:n,base64:this.result})},r.readAsDataURL(n)})}function p(n,e=.8,i=1500,a=!1,r="https://testingcf.jsdelivr.net/npm/exifr/dist/lite.umd.js"){return new Promise(t=>{const o=new FileReader;o.readAsDataURL(n),o.onloadend=g=>{const s=new Image;s.onload=async()=>{let l=s.width,c=s.height,m=1;if(Math.max(l,c)>i&&(m=i/Math.max(l,c)),m<1||n.size>=2*1024*1024){l=l*m,c=c*m;const h=document.createElement("canvas"),d=h.getContext("2d");if(h.width=l,h.height=c,a)try{window.exifr||await R(r),exifr.orientation(n).then(f=>{if(f!==1&&f!==void 0&&f!==0)switch(f){case 6:h.width=c,h.height=l,d.rotate(Math.PI/2),d.drawImage(s,0,-c,l,c);break;case 8:h.width=c,h.height=l,d.rotate(-90*Math.PI/180),d.drawImage(s,-l,0,l,c);break;case 3:d.rotate(Math.PI),d.drawImage(s,-l,-c,l,c);break;default:d.drawImage(s,0,0,s.width,s.height,0,0,l,c)}else d.drawImage(s,0,0,s.width,s.height,0,0,l,c);t(h.toDataURL("image/jpeg",e))}).catch(()=>{d.drawImage(s,0,0,s.width,s.height,0,0,l,c),t(h.toDataURL("image/jpeg",e))})}catch{d.drawImage(s,0,0,s.width,s.height,0,0,l,c),t(h.toDataURL("image/jpeg",e))}else d.drawImage(s,0,0,s.width,s.height,0,0,l,c),t(h.toDataURL("image/jpeg",e))}else t(g.target.result)},s.src=g.target.result}})}function L(n,{currentTime:e=.5,width:i,height:a}={}){return new Promise(async r=>{const t=document.createElement("video");t.currentTime=e,t.setAttribute("crossOrigin","anonymous"),t.setAttribute("src",n),i&&a?(t.setAttribute("width",i),t.setAttribute("height",a)):await new Promise(o=>{t.onloadedmetadata=()=>{window.URL.revokeObjectURL(t.src),a=t.videoHeight,i=t.videoWidth,o()}}),t.addEventListener("loadeddata",function(){const o=document.createElement("canvas");o.width=i,o.height=a,o.getContext("2d").drawImage(t,0,0,i,a),r(o.toDataURL("image/jpeg"))})})}function x(n,e,i="blob"){const a=n.split(","),r=a[0].match(/:(.*?);/)[1],t=atob(a[1]);let o=t.length;const g=new Uint8Array(o);for(;o--;)g[o]=t.charCodeAt(o);if(i==="blob"){const s=new Blob([g],{type:r});return s.lastModifiedDate=new Date,s.name=e,s}return new File([g],e,{type:r})}function A(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){let e=Math.random()*16|0;return(n=="x"?e:e&3|8).toString(16)})}function w(n,e="jpeg"){var a;let i;return(i=(a=/(?=\/(\S+))/.exec(n.type))==null?void 0:a[1])&&(e=i),A()+"."+e}function R(n){return new Promise(e=>{const i=document.createElement("script");i.setAttribute("src",n),i.setAttribute("charset","UTF-8"),document.querySelector("html").appendChild(i),i.onload=e})}class D{constructor(e={}){u(this,"el");u(this,"dragWrapEl");u(this,"fileList");u(this,"maxLength");u(this,"maxSize");u(this,"compress");u(this,"videoCover");u(this,"extReg");u(this,"dragCb");if(this.fileList=[],e.el)this.el=e.el;else{const i=document.createElement("input");i.setAttribute("style","display:none;opacty:0;width:0;height:0;"),i.setAttribute("hidden","hidden"),i.setAttribute("type","file"),this.el=i,document.body.appendChild(this.el)}this.initDrag(e.dragWrapEl),this.changeOptions(e)}changeOptions(e){return this.maxSize=e.maxSize||500,this.compress=e.compress||!1,this.videoCover=e.videoCover,this.maxLength=e.maxLength||99999,this.extReg=e.extReg===null?null:new RegExp(`\\/(${e.extReg||"png|jpe?g|webp"})$`,"i"),e.multiple?this.el.setAttribute("multiple",""):this.el.removeAttribute("multiple"),this.el.setAttribute("accept",e.accept||"image/jpg,image/jpeg,image/png,image/gif"),e.accept===null&&this.el.removeAttribute("accept"),this}clear(){this.el.value="",this.fileList=[]}destroy(){this.el.remove()}on(e,i){switch(e){case"drag":this.dragCb=i;break}}getFileList(){return this.fileList}async fileDataTransHandler(e){if(this.getFileList().length>=this.maxLength)return this.el.value="",Promise.reject("限制上传"+this.maxLength+"个文件");const i=[];for(let r=0,t=e.length;r<t;r++){const o=e[r];if(this.extReg!==null&&!this.extReg.test(o.type))return Promise.reject("请选择正确的文件类型");if(o.size>=this.maxSize*1024)return Promise.reject("请选择小于"+this.maxSize+"kb的文件");i.push(y(o,this.compress,this.videoCover))}const a=await Promise.all(i).catch(()=>[]);return this.fileList.push(...a),a}initDrag(e){e&&(e.setAttribute("title","拖拽文件到此上传"),e.style.cursor="pointer",e.addEventListener("dragenter",function(i){i.preventDefault()},!1),e.addEventListener("dragover",function(i){i.preventDefault()},!1),e.addEventListener("drop",async i=>{var a,r;i.preventDefault(),(r=(a=i.dataTransfer)==null?void 0:a.files)!=null&&r.length&&this.fileDataTransHandler(i.dataTransfer.files).then(t=>{this.dragCb&&this.dragCb(null,t),e.dispatchEvent(new CustomEvent("chooseFile",{detail:t}))}).catch(t=>{this.dragCb&&this.dragCb(t,[])})},!1))}chooseFile(e){return e&&this.el.setAttribute("accept",e),new Promise((i,a)=>{this.el.click();const r=this;this.el.onchange=function(){const t=this==null?void 0:this.files;t!=null&&t.length&&r.fileDataTransHandler(t).then(i).catch(a)}})}}export{D as F};
